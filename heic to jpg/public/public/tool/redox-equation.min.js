var ions=!1;function chemistry(){setMessage("");var balancedElem=document.getElementById("result"),codeOutElem=document.getElementById("codevalid"),eqn;removeAllChildren(balancedElem),removeAllChildren(codeOutElem),codeOutElem.appendChild(document.createTextNode(NBSP));try{eqn=parse()}catch(e){if("string"==typeof e)$("#result").text(""),setMessage("Equation error: "+e);else if("start"in e&&"end"in e){setMessage("Equation error: "+e.message),$("#result").text("");for(var input=$("#chemeuqation").val(),start=e.start,end=e.end;start<input.length&&start<end&&" "==input.charAt(start);)start++;for(;end>=1&&start<end&&" "==input.charAt(end-1);)end--;var highlight;removeAllChildren(codeOutElem),codeOutElem.appendChild(document.createTextNode(input.substring(0,start))),(highlight=document.createElement("u")).appendChild(document.createTextNode(input.substring(start,end))),codeOutElem.appendChild(highlight),codeOutElem.appendChild(document.createTextNode(input.substring(end,input.length)))}else if("start"in e){setMessage("Equation error: "+e.message);var input=document.getElementById("chemeuqation").value,start=e.start;removeAllChildren(codeOutElem),codeOutElem.appendChild(document.createTextNode(input.substring(0,start)));var highlight=document.createElement("u");start!=input.length?(highlight.appendChild(document.createTextNode(input.substring(start,start+1))),codeOutElem.appendChild(highlight),codeOutElem.appendChild(document.createTextNode(input.substring(start+1,input.length)))):(highlight.appendChild(document.createTextNode(NBSP)),codeOutElem.appendChild(highlight))}else setMessage("Assertion error");return}try{var matrix=buildMatrix(eqn);solve(matrix);var coefs=extractCoefficients(matrix);checkAnswer(eqn,coefs),$("#result").append(eqn.toHtml(coefs)),$("#equation-input").text($("#chemeuqation").val()),scrollToResult()}catch(e){setMessage(e.toString())}}function show(str){$("#chemeuqation").val(str),chemistry()}function parse(){var input,tokenizer;return parseEquation(new Tokenizer($("#chemeuqation").val()))}function buildMatrix(eqn){for(var elems=eqn.getElements(),rows,cols,matrix=new Matrix(elems.length+1,eqn.getLeftSide().length+eqn.getRightSide().length+1),i=0;i<elems.length;i++){for(var j=0,k=0,lhs=eqn.getLeftSide();k<lhs.length;j++,k++)matrix.set(i,j,lhs[k].countElement(elems[i]));for(var k=0,rhs=eqn.getRightSide();k<rhs.length;j++,k++)matrix.set(i,j,-rhs[k].countElement(elems[i]))}return matrix}function solve(matrix){var i;for(matrix.gaussJordanEliminate(),i=0;i<matrix.rowCount()-1&&!(countNonzeroCoeffs(matrix,i)>1);i++);if(i==matrix.rowCount()-1)throw"Element combination incorrect";matrix.set(matrix.rowCount()-1,i,1),matrix.set(matrix.rowCount()-1,matrix.columnCount()-1,1),matrix.gaussJordanEliminate()}function countNonzeroCoeffs(matrix,row){for(var count=0,i=0;i<matrix.columnCount();i++)0!=matrix.get(row,i)&&count++;return count}function extractCoefficients(matrix){var rows=matrix.rowCount(),cols=matrix.columnCount();if(cols-1>rows||0==matrix.get(cols-2,cols-2))throw"No unique solution";for(var lcm=1,i=0;i<cols-1;i++)lcm=checkedMultiply(lcm/gcd(lcm,matrix.get(i,i)),matrix.get(i,i));for(var coefs=[],allzero=!0,i=0;i<cols-1;i++){var coef=checkedMultiply(lcm/matrix.get(i,i),matrix.get(i,cols-1));coefs.push(coef),allzero&=0==coef}if(allzero)throw"Assertion error: All zero solution";return coefs}function checkAnswer(eqn,coefs){if(coefs.length!=eqn.getLeftSide().length+eqn.getRightSide().length)throw"Assertion error: Mismatched length";for(var allzero=!0,i=0;i<coefs.length;i++){var coef=coefs[i];if("number"!=typeof coef||isNaN(coef)||Math.floor(coef)!=coef)throw"Assertion error: Not an integer";allzero&=0==coef}if(allzero)throw"Assertion error: Solution of all zeros";for(var elems=eqn.getElements(),i=0;i<elems.length;i++){for(var sum=0,j=0,k=0,lhs=eqn.getLeftSide();k<lhs.length;j++,k++)sum=checkedAdd(sum,checkedMultiply(lhs[k].countElement(elems[i]),coefs[j]));for(var k=0,rhs=eqn.getRightSide();k<rhs.length;j++,k++)sum=checkedAdd(sum,checkedMultiply(rhs[k].countElement(elems[i]),-coefs[j]));if(0!=sum)throw"Assertion error: Balance failed"}}function Equation(lhs,rhs){lhs=cloneArray(lhs),rhs=cloneArray(rhs),this.getLeftSide=function(){return cloneArray(lhs)},this.getRightSide=function(){return cloneArray(rhs)},this.getElements=function(){for(var result=new Set,i=0;i<lhs.length;i++)lhs[i].getElements(result);for(var i=0;i<rhs.length;i++)rhs[i].getElements(result);return result.toArray()},this.toHtml=function(coefs){if(void 0!==coefs&&coefs.length!=lhs.length+rhs.length)throw"Mismatched number of coefficients";for(var node=document.createElement("span"),initial=!0,i=0;i<lhs.length;i++){var coef;if(0!=(coef=void 0!==coefs?coefs[i]:1)){var disp;if(initial?initial=!1:node.appendChild(document.createTextNode(" + ")),1!=coef)(disp=document.createElement("span")).setAttribute("style","font-weight:bold;color:blue;display:inline-table;"),disp.appendChild(document.createTextNode(coef.toString().replace(/-/,MINUS))),node.appendChild(disp);node.appendChild(document.createTextNode(" ")),node.appendChild(lhs[i].toHtml())}}var disp;(disp=document.createElement("span")).setAttribute("style","font-weight:bold;color:#000;font-size:30px;vertical-align: -6px;display:inline-table;"),disp.appendChild(document.createTextNode(" → ")),node.appendChild(disp),initial=!0;for(var i=0;i<rhs.length;i++){var coef;if(0!=(coef=void 0!==coefs?coefs[lhs.length+i]:1)){var disp;if(initial?initial=!1:node.appendChild(document.createTextNode(" + ")),1!=coef)(disp=document.createElement("span")).setAttribute("style","font-weight:bold;color:blue;display:inline-table;"),disp.appendChild(document.createTextNode(coef.toString().replace(/-/,MINUS))),node.appendChild(disp);node.appendChild(document.createTextNode(" ")),node.appendChild(rhs[i].toHtml())}}return node}}function Term(items,charge){if(0!=charge&&(ions=!0),0==ions&&0==charge)throw"Invalid term, Elements must be with Ions";if(0==items.length&&-1!=charge)throw"Invalid term ";items=cloneArray(items),this.getItems=function(){return cloneArray(items)},this.getElements=function(result){result.add("e");for(var i=0;i<items.length;i++)items[i].getElements(result)},this.countElement=function(name){if("e"==name)return-charge;for(var sum=0,i=0;i<items.length;i++)sum=checkedAdd(sum,items[i].countElement(name));return sum},this.toHtml=function(){var node=document.createElement("span");if(node.setAttribute("style","font-weight:bold;color:#39b4bd;display:inline-table;"),0==items.length&&-1==charge){var sup;node.appendChild(document.createTextNode("e")),(sup=document.createElement("sup")).setAttribute("style","font-weight:bold;color:#FC5F61;display:inline-table;"),sup.appendChild(document.createTextNode(" ")),sup.appendChild(document.createTextNode(MINUS)),node.appendChild(sup)}else{for(var i=0;i<items.length;i++)node.appendChild(items[i].toHtml());var sup,s;if(0!=charge)(sup=document.createElement("sup")).setAttribute("style","font-weight:bold;color:#FC5F61;display:inline-table;"),s=1==Math.abs(charge)?"":Math.abs(charge).toString(),s+=charge>0?"+":MINUS,sup.appendChild(document.createTextNode(" ")),sup.appendChild(document.createTextNode(s)),node.appendChild(sup)}return node}}function Group(items,count){if(count<1)throw"Count must be a positive integer";items=cloneArray(items),this.getItems=function(){return cloneArray(items)},this.getCount=function(){return count},this.getElements=function(result){for(var i=0;i<items.length;i++)items[i].getElements(result)},this.countElement=function(name){for(var sum=0,i=0;i<items.length;i++)sum=checkedAdd(sum,checkedMultiply(items[i].countElement(name),count));return sum},this.toHtml=function(){var node=document.createElement("span");node.setAttribute("style","font-weight:bold;color:#39b4bd;display:inline-table;"),node.appendChild(document.createTextNode("("));for(var i=0;i<items.length;i++)node.appendChild(items[i].toHtml());if(node.appendChild(document.createTextNode(")")),1!=count){var sub=document.createElement("sub");sub.setAttribute("style","font-weight:bold;color:#7E178C;display:inline-table;"),sub.appendChild(document.createTextNode(count.toString())),node.appendChild(sub)}return node}}function Element(name,count){if(count<1)throw"Count must be a positive integer";this.getName=function(){return name},this.getCount=function(){return count},this.getElements=function(result){result.add(name)},this.countElement=function(n){return n==name?count:0},this.toHtml=function(){var node=document.createElement("span");if(node.setAttribute("style","font-weight:bold;color:#39b4bd;display:inline-table;"),node.appendChild(document.createTextNode(name)),1!=count){var sub=document.createElement("sub");sub.setAttribute("style","font-weight:bold;color:#346EE2;display:inline-table;"),sub.appendChild(document.createTextNode(count.toString())),node.appendChild(sub)}return node}}function parseEquation(tok){var lhs=[],rhs=[];for(lhs.push(parseTerm(tok));;){var next;if("="==(next=tok.peek()))break;if(null==next)throw{message:"Plus or equal sign expected",start:tok.position()};if("+"!=next)throw{message:"Plus expected",start:tok.position()};tok.take(),lhs.push(parseTerm(tok))}if("="!=tok.take())throw"Assertion error";for(rhs.push(parseTerm(tok));;){var next;if(null==(next=tok.peek()))break;if("+"!=next)throw{message:"Plus expected",start:tok.position()};tok.take(),rhs.push(parseTerm(tok))}return new Equation(lhs,rhs)}function parseTerm(tok){for(var startPosition=tok.position(),items=[];;){var next;if(null==(next=tok.peek()))break;if("("==next)items.push(parseGroup(tok));else{if(!/^[A-Za-z][a-z]*$/.test(next))break;items.push(parseElement(tok))}}var charge=0,next;if(null!=(next=tok.peek())&&"^"==next){if(tok.take(),null==(next=tok.peek()))throw{message:"Number or sign expected",start:tok.position()};if(/^[0-9]+$/.test(next)?(charge=checkedParseInt(next,10),tok.take(),next=tok.peek()):charge=1,null==next)throw{message:"Sign expected",start:tok.position()};if("+"==next);else{if("-"!=next)throw{message:"Sign expected",start:tok.position()};charge=-charge}tok.take()}for(var elems=new Set,i=0;i<items.length;i++)items[i].getElements(elems);if(elems=elems.toArray(),0==items.length)throw{message:"Invalid term ",start:startPosition,end:tok.position()};if(-1!=indexOf(elems,"e")){if(items.length>1||0!=charge&&-1!=charge)throw{message:"Invalid term ",start:startPosition,end:tok.position()};items=[],charge=-1}else for(var i=0;i<elems.length;i++)if(/^[a-z]+$/.test(elems[i]))throw{message:"Invalid element "+elems[i],start:startPosition,end:tok.position()};return new Term(items,charge)}function parseGroup(tok){if("("!=tok.take())throw"Assertion error";for(var items=[];;){var next=tok.peek();if(null==next)throw{message:"Element, group, or closing parenthesis expected",start:tok.position()};if("("==next)items.push(parseGroup(tok));else{if(!/^[A-Za-z][a-z]*$/.test(next)){if(")"==next)break;throw{message:"Element, group, or closing parenthesis expected",start:tok.position()}}items.push(parseElement(tok))}}if(")"!=tok.take())throw"Assertion error";return new Group(items,parseCount(tok))}function parseElement(tok){var name=tok.take();if(!/^[A-Za-z][a-z]*$/.test(name))throw"Assertion error";return new Element(name,parseCount(tok))}function parseCount(tok){var next=tok.peek();return null!=next&&/^[0-9]+$/.test(next)?checkedParseInt(tok.take(),10):1}function Tokenizer(str){var i=0;this.position=function(){return i},this.peek=function(){if(i==str.length)return null;var match=/^([A-Za-z][a-z]*|[0-9]+| +|[+\-^=()])/.exec(str.substring(i));if(null==match)throw{message:"Invalid symbol ",start:i};var token=match[0];return/^ +$/.test(token)&&(i+=token.length,token=this.peek()),token},this.take=function(){var result=this.peek();return i+=result.length,result}}function Matrix(rows,cols){for(var cells=[],i=0;i<rows;i++){for(var row=[],j=0;j<cols;j++)row.push(0);cells.push(row)}function swapRows(i,j){if(i<0||i>=rows||j<0||j>=rows)throw"Index out of bounds";var temp=cells[i];cells[i]=cells[j],cells[j]=temp}function addRows(x,y){for(var z=cloneArray(x),i=0;i<z.length;i++)z[i]=checkedAdd(x[i],y[i]);return z}function multiplyRow(x,c){for(var y=cloneArray(x),i=0;i<y.length;i++)y[i]=checkedMultiply(x[i],c);return y}function gcdRow(x){for(var result=0,i=0;i<x.length;i++)result=gcd(x[i],result);return result}function simplifyRow(x){for(var sign=0,i=0;i<x.length;i++){if(x[i]>0){sign=1;break}if(x[i]<0){sign=-1;break}}var y=cloneArray(x);if(0==sign)return y;for(var g=gcdRow(x)*sign,i=0;i<y.length;i++)y[i]/=g;return y}this.rowCount=function(){return rows},this.columnCount=function(){return cols},this.get=function(r,c){if(r<0||r>=rows||c<0||c>=cols)throw"Index out of bounds";return cells[r][c]},this.set=function(r,c,val){if(r<0||r>=rows||c<0||c>=cols)throw"Index out of bounds";cells[r][c]=val},this.gaussJordanEliminate=function(){for(var i=0;i<rows;i++)cells[i]=simplifyRow(cells[i]);for(var numPivots=0,i=0;i<cols;i++){for(var pivotRow=numPivots;pivotRow<rows&&0==cells[pivotRow][i];)pivotRow++;if(pivotRow!=rows){var pivot=cells[pivotRow][i];swapRows(numPivots,pivotRow);for(var j=++numPivots;j<rows;j++){var g=gcd(pivot,cells[j][i]);cells[j]=simplifyRow(addRows(multiplyRow(cells[j],pivot/g),multiplyRow(cells[i],-cells[j][i]/g)))}}}for(var i=rows-1;i>=0;i--){for(var pivotCol=0;pivotCol<cols&&0==cells[i][pivotCol];)pivotCol++;if(pivotCol!=cols)for(var pivot=cells[i][pivotCol],j=i-1;j>=0;j--){var g=gcd(pivot,cells[j][pivotCol]);cells[j]=simplifyRow(addRows(multiplyRow(cells[j],pivot/g),multiplyRow(cells[i],-cells[j][pivotCol]/g)))}}},this.toString=function(){for(var result="[",i=0;i<rows;i++){0!=i&&(result+="],\n"),result+="[";for(var j=0;j<cols;j++)0!=j&&(result+=", "),result+=cells[i][j];result+="]"}return result+"]"}}function Set(){var items=[];this.add=function(obj){-1==indexOf(items,obj)&&items.push(obj)},this.contains=function(obj){return-1!=items.indexOf(obj)},this.toArray=function(){return cloneArray(items)}}var NBSP=" ",MINUS="−",INT_MAX=9007199254740992;function checkedParseInt(str){var result=parseInt(str,10);if(isNaN(result))throw"Not a number";if(result<=-INT_MAX||result>=INT_MAX)throw"Arithmetic overflow";return result}function checkedAdd(x,y){var z=x+y;if(z<=-INT_MAX||z>=INT_MAX)throw"Arithmetic overflow";return z}function checkedMultiply(x,y){var z=x*y;if(z<=-INT_MAX||z>=INT_MAX)throw"Arithmetic overflow";return z}function gcd(x,y){if("number"!=typeof x||"number"!=typeof y||isNaN(x)||isNaN(y))throw"Invalid argument ";for(x=Math.abs(x),y=Math.abs(y);0!=y;){var z=x%y;x=y,y=z}return x}function indexOf(array,item){for(var i=0;i<array.length;i++)if(array[i]==item)return i;return-1}function cloneArray(array){return array.slice(0)}function setMessage(str){var messageElem=document.getElementById("message");removeAllChildren(messageElem),messageElem.appendChild(document.createTextNode(str))}function removeAllChildren(node){for(;node.childNodes.length>0;)node.removeChild(node.firstChild)}$((function(){$("#chemeuqation").on("click",(function(){$("html, body").animate({scrollTop:$("#top-input").offset().top},500)})),$(".example-link").on("click",(function(){$("#chemeuqation").val($(this).text()),$("html, body").animate({scrollTop:$("#top-input").offset().top},500)})),$("#balanceBtn").on("click",(function(){chemistry()}))}));